generator client {
  provider        = "prisma-client-js"
  previewFeatures = []
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PurchaseStatus {
  PENDING
  PAID
  CANCELLED
}

model Product {
  id             String                @id @default(cuid())
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  title          String
  description    String?
  price          Decimal               @db.Decimal(10, 2)
  imageUrl       String?
  category       String                @default("uncategorized")
  isActive       Boolean               @default(true)
  inventoryCount Int                   @default(0)
  purchases      PurchaseItem[]
  adjustments    InventoryAdjustment[]

  @@index([isActive])
  @@map("products")
}

model InventoryAdjustment {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  quantity   Int
  reason     String?
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId  String
  recordedBy String?

  @@map("inventory_adjustments")
}

model Purchase {
  id          String         @id @default(cuid())
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  reference   String         @unique
  status      PurchaseStatus @default(PENDING)
  totalAmount Decimal        @db.Decimal(10, 2)
  items       PurchaseItem[]
  notes       String?
  isDeleted   Boolean        @default(false)
  deletedAt   DateTime?
  deletedByAdmin   AdminUser?   @relation("PurchaseDeletedBy", fields: [deletedByAdminId], references: [id])
  deletedByAdminId String?

  @@map("purchases")
  @@index([isDeleted])
}

model PurchaseItem {
  id         String   @id @default(cuid())
  quantity   Int
  unitPrice  Decimal  @db.Decimal(10, 2)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Restrict)
  productId  String
  purchase   Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  purchaseId String

  @@index([productId])
  @@map("purchase_items")
}

model KioskSetting {
  id                String   @id @default("default")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  inventoryEnabled  Boolean  @default(true)

  @@map("kiosk_settings")
}

model AdminUser {
  id                 String                @id @default(cuid())
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  email              String                @unique
  username           String                @unique
  passwordHash       String
  passwordAlgorithm  String
  passwordVersion    Int                   @default(1)
  isActive           Boolean               @default(true)
  lastLoginAt        DateTime?
  failedLoginAttempts Int                  @default(0)
  resetTokens        PasswordResetToken[]
  deletedPurchases   Purchase[]            @relation("PurchaseDeletedBy")

  @@map("admin_users")
}

model PasswordResetToken {
  id           String    @id @default(cuid())
  tokenHash    String    @unique
  expiresAt    DateTime
  consumedAt   DateTime?
  createdAt    DateTime  @default(now())
  adminUser    AdminUser @relation(fields: [adminUserId], references: [id], onDelete: Cascade)
  adminUserId  String

  @@map("password_reset_tokens")
}
